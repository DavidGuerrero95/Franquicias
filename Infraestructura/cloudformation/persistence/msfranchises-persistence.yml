AWSTemplateFormatVersion: "2010-09-09"
Description: >
  MsFranchises - Persistence (Public RDS for demo):
  VPC (2 AZ public subnets), RDS MySQL publicly accessible, encrypted with KMS,
  Secrets Manager secret (KMS) + Custom Resource to enrich secret with RDS endpoint.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label: { default: "Project" }
        Parameters: [ProjectName, Environment]
      - Label: { default: "Network (Public)" }
        Parameters: [VpcCidr, PublicSubnet1Cidr, PublicSubnet2Cidr, AllowedDbIngressCidr]
      - Label: { default: "Database" }
        Parameters: [DbName, DbUsername, DbInstanceClass, DbAllocatedStorageGb, DbMultiAZ, BackupRetentionDays, DeletionProtection, DbPubliclyAccessible]
      - Label: { default: "Secrets" }
        Parameters: [DbSecretName]

Parameters:
  ProjectName:
    Type: String
    Default: msfranchises
    AllowedPattern: "^[a-zA-Z0-9-]+$"

  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, qa, prod]

  VpcCidr:
    Type: String
    Default: 10.30.0.0/16

  PublicSubnet1Cidr:
    Type: String
    Default: 10.30.0.0/24

  PublicSubnet2Cidr:
    Type: String
    Default: 10.30.1.0/24

  # se deja 0.0.0.0 para demo.
  AllowedDbIngressCidr:
    Type: String
    Default: 0.0.0.0/0
    AllowedPattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}\\/[0-9]{1,2}$"

  DbName:
    Type: String
    Default: franchises
    AllowedPattern: "^[a-zA-Z0-9_]+$"

  DbUsername:
    Type: String
    Default: franchises_user
    AllowedPattern: "^[a-zA-Z0-9_]+$"
    MinLength: 1
    MaxLength: 16

  DbInstanceClass:
    Type: String
    Default: db.t3.micro

  DbAllocatedStorageGb:
    Type: Number
    Default: 20
    MinValue: 20
    MaxValue: 1000

  DbMultiAZ:
    Type: String
    Default: "false"
    AllowedValues: ["true", "false"]

  BackupRetentionDays:
    Type: Number
    Default: 7
    MinValue: 0
    MaxValue: 35

  DeletionProtection:
    Type: String
    Default: "false"
    AllowedValues: ["true", "false"]

  DbPubliclyAccessible:
    Type: String
    Default: "true"
    AllowedValues: ["true", "false"]

  DbSecretName:
    Type: String
    Default: ms-franchises/mysql
    MinLength: 1

Conditions:
  EnableDeletionProtection: !Equals [!Ref DeletionProtection, "true"]
  EnableMultiAZ: !Equals [!Ref DbMultiAZ, "true"]
  EnablePublicAccess: !Equals [!Ref DbPubliclyAccessible, "true"]

Resources:
  Vpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-vpc"

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-igw"

  IgwAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref Vpc
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: !Ref PublicSubnet1Cidr
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-public-a"

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select [1, !GetAZs ""]
      CidrBlock: !Ref PublicSubnet2Cidr
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-public-b"

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-public-rt"

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: IgwAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RtAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RtAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  DataKmsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: !Sub "KMS key for ${ProjectName}-${Environment} (RDS + Secrets)"
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowAccountRootAdmin
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"

  DataKmsAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${ProjectName}-${Environment}-data"
      TargetKeyId: !Ref DataKmsKey

  DbSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: RDS SG - allow MySQL from AllowedDbIngressCidr (demo)
      VpcId: !Ref Vpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: !Ref AllowedDbIngressCidr
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-rds-sg"

  DbSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Public subnets for RDS (demo)
      SubnetIds:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-dbsubnets"

  DbSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Ref DbSecretName
      Description: !Sub "DB secret for ${ProjectName}-${Environment}"
      KmsKeyId: !Ref DataKmsKey
      GenerateSecretString:
        SecretStringTemplate: !Sub |
          {"host":"","port":3306,"dbname":"${DbName}","username":"${DbUsername}"}
        GenerateStringKey: "password"
        PasswordLength: 32
        ExcludePunctuation: true
        ExcludeCharacters: "\"'@\\/"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  DbInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub "${ProjectName}-${Environment}-mysql"
      Engine: mysql
      DBInstanceClass: !Ref DbInstanceClass
      AllocatedStorage: !Ref DbAllocatedStorageGb
      StorageType: gp3
      StorageEncrypted: true
      KmsKeyId: !Ref DataKmsKey
      PubliclyAccessible: !If [EnablePublicAccess, true, false]
      MultiAZ: !If [EnableMultiAZ, true, false]
      BackupRetentionPeriod: !Ref BackupRetentionDays
      CopyTagsToSnapshot: true
      AutoMinorVersionUpgrade: true
      DeletionProtection: !If [EnableDeletionProtection, true, false]
      DBName: !Ref DbName
      MasterUsername: !Ref DbUsername
      MasterUserPassword: !Sub "{{resolve:secretsmanager:${DbSecret}:SecretString:password}}"
      VPCSecurityGroups:
        - !Ref DbSecurityGroup
      DBSubnetGroupName: !Ref DbSubnetGroup

  SecretEnricherRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: { Service: lambda.amazonaws.com }
            Action: sts:AssumeRole
      Policies:
        - PolicyName: SecretEnricherPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: ReadWriteSpecificSecret
                Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:PutSecretValue
                  - secretsmanager:DescribeSecret
                Resource: !Ref DbSecret
              - Sid: DescribeRds
                Effect: Allow
                Action:
                  - rds:DescribeDBInstances
                Resource: "*"
              - Sid: KmsUseForSecret
                Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:Encrypt
                  - kms:GenerateDataKey
                  - kms:DescribeKey
                Resource: !GetAtt DataKmsKey.Arn
              - Sid: Logs
                Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"

  SecretEnricherFn:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python3.12
      Handler: index.handler
      Role: !GetAtt SecretEnricherRole.Arn
      Timeout: 60
      MemorySize: 128
      Code:
        ZipFile: |
          import json, boto3, urllib.request
          def _send(event, context, status, data, physical_id):
            body = {
              "Status": status,
              "Reason": f"See CloudWatch logs: {context.log_stream_name}",
              "PhysicalResourceId": physical_id or context.log_stream_name,
              "StackId": event["StackId"],
              "RequestId": event["RequestId"],
              "LogicalResourceId": event["LogicalResourceId"],
              "Data": data or {}
            }
            req = urllib.request.Request(
              event["ResponseURL"],
              data=json.dumps(body).encode("utf-8"),
              headers={"content-type": ""},
              method="PUT"
            )
            urllib.request.urlopen(req)

          def handler(event, context):
            props = event.get("ResourceProperties", {})
            secret_id = props["SecretId"]
            db_id = props["DbInstanceId"]
            dbname = props["DbName"]
            sm = boto3.client("secretsmanager")
            rds = boto3.client("rds")
            try:
              if event["RequestType"] in ("Create","Update"):
                db = rds.describe_db_instances(DBInstanceIdentifier=db_id)["DBInstances"][0]
                host = db["Endpoint"]["Address"]
                port = db["Endpoint"]["Port"]
                cur = sm.get_secret_value(SecretId=secret_id)
                obj = json.loads(cur.get("SecretString","{}"))
                obj["host"] = host
                obj["port"] = int(port)
                obj["dbname"] = dbname
                sm.put_secret_value(SecretId=secret_id, SecretString=json.dumps(obj))
                _send(event, context, "SUCCESS", {"Host": host, "Port": str(port)}, secret_id)
              else:
                _send(event, context, "SUCCESS", {}, secret_id)
            except Exception as e:
              _send(event, context, "FAILED", {"Error": str(e)}, secret_id)

  EnrichDbSecret:
    Type: Custom::SecretEnricher
    DependsOn: DbInstance
    Properties:
      ServiceToken: !GetAtt SecretEnricherFn.Arn
      SecretId: !Ref DbSecret
      DbInstanceId: !Ref DbInstance
      DbName: !Ref DbName

Outputs:
  VpcId:
    Value: !Ref Vpc
  PublicSubnetIds:
    Value: !Join [",", [!Ref PublicSubnet1, !Ref PublicSubnet2]]
  DbSecurityGroupId:
    Value: !Ref DbSecurityGroup
  DbEndpointAddress:
    Value: !GetAtt DbInstance.Endpoint.Address
  DbEndpointPort:
    Value: !GetAtt DbInstance.Endpoint.Port
  DbSecretArn:
    Value: !Ref DbSecret
  DbSecretName:
    Value: !Ref DbSecretName