name: franquicias-local

services:
  init-perms:
    image: alpine:3.20
    container_name: msfranchises-init-perms
    restart: "no"
    volumes:
      - ./Infraestructura/local/localstack/localstack-init:/localstack-init
    command: ["sh","-c","chmod +x /localstack-init/*.sh 2>/dev/null || true"]

  localstack:
    image: localstack/localstack:3
    container_name: msfranchises-localstack
    restart: unless-stopped
    depends_on:
      init-perms:
        condition: service_completed_successfully
    environment:
      SERVICES: "secretsmanager"
      DEFAULT_REGION: "us-east-1"
      DEBUG: "0"
      TZ: "America/Bogota"

      DB_SECRET_NAME: "ms-franchises/mysql"
      MYSQL_HOST: "${RDS_HOST}"
      MYSQL_PORT: "3306"
      MYSQL_DB: "franchises"
      MYSQL_USER: "franchises_user"
      MYSQL_PASSWORD: "${RDS_PASSWORD}"
    ports:
      - "4566:4566"
    volumes:
      - ./Infraestructura/local/localstack/localstack-init:/etc/localstack/init/ready.d
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -fsS http://localhost:4566/_localstack/health | grep -q '\"secretsmanager\"'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 10s
    networks:
      - santinet

  msfranchises:
    image: msfranchises:local
    build:
      context: ./MsFranchises
      dockerfile: deployment/Dockerfile
    container_name: msfranchises-app
    restart: unless-stopped
    depends_on:
      localstack:
        condition: service_healthy
    environment:
      TZ: "America/Bogota"
      SERVER_PORT: "8080"
      PATH_BASE: "/ms-franchises/api/v1/"
      SHOW_DETAILS: "always"

      AWS_REGION: "us-east-1"
      AWS_SM_ENDPOINT: "http://localstack:4566"
      AWS_ACCESS_KEY_ID: "test"
      AWS_SECRET_ACCESS_KEY: "test"
      DB_SECRET_NAME: "ms-franchises/mysql"
    ports:
      - "8080:8080"
    networks:
      - santinet

networks:
  santinet: {}